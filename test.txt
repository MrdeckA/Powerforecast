import streamlit as st
import pandas as pd
from io import StringIO
import plost
import pickle
from streamlit_option_menu import option_menu
from src.data_analysis import importation_of_dataset  , box_plot , add_month_or_hour, boxplot_months


def read_pred_results(file_pkl):
    with open(file_pkl, 'rb') as fp:
        df_predictions = pickle.load(fp)
    return df_predictions

def draw_forecast_page():
    path_ = "Tetuan City power consumption.csv"
    path_ = importation_of_dataset(path_)


    # Différents fichiers de résultats
    # Zone 1
    file_z1_xgboost = "predictions/Zone1/xgboost_predictions_Consumption_Z1.pkl"
    file_z1_lstm1h = "predictions/Zone1/lstm1H_predictions_Consumption_Z1.pkl"
    file_z1_lstm = "predictions/Zone1/lstm_predictions_Consumption_Z1.pkl"
    # Zone 2
    file_z2_xgboost = "predictions/Zone2/xgboost_predictions_Consumption_Z2.pkl"
    file_z2_lstm1h = "predictions/Zone2/lstm1H_predictions_Consumption_Z2.pkl"
    file_z2_lstm = "predictions/Zone2/lstm_predictions_Consumption_Z2.pkl"
    # Sone 3
    file_z3_xgboost = "predictions/Zone3/xgboost_predictions_Consumption_Z3.pkl"
    file_z3_lstm1h = "predictions/Zone3/lstm1H_predictions_Consumption_Z3.pkl"
    file_z3_lstm = "predictions/Zone3/lstm_predictions_Consumption_Z3.pkl"

    with open('style.css') as f:
        st.markdown(f'<style>{f.read()}</style>', unsafe_allow_html=True)
    
    st.sidebar.header('Prédictions de la consommation énergétique')


    st.sidebar.subheader('Zone de la ville de Tetouan')
    plot_data = st.sidebar.multiselect('Selectionner une zone', ['Zone 1', 'Zone 2', 'Zone 3'], ['Zone 1', 'Zone 2', 'Zone 3'])
    st.sidebar.subheader('')

    plot_height = st.sidebar.slider('Specify plot height', 200, 500, 250)




    


    st.sidebar.markdown('''
    ---
        Created with ❤️ by [PowerForecast_Team]
    ''')


    # Row A
    # st.markdown('### Metrics')
    # col1, col2, col3 = st.columns(3)
    # col1.metric("Temperature", "70 °F", "1.2 °F")
    # col2.metric("Wind", "9 mph", "-8%")
    # col3.metric("Humidity", "86%", "4%")

    # Row B
    # seattle_weather = pd.read_csv('https://raw.githubusercontent.com/MrdeckA/Powerforecast/main/Tetuan%20City%20power%20consumption.csv')
    seattle_weather = pd.read_csv('https://raw.githubusercontent.com/tvst/plost/master/data/seattle-weather.csv', parse_dates=['date'])
    stocks = pd.read_csv('https://raw.githubusercontent.com/dataprofessor/data/master/stocks_toy.csv')
    option = st.radio("Période de visualistion   :", ("Mois", "Jour", "Heure"))

    first_day = path_.index[0]
    last_day = path_.index[-1]
    

    date_range = \
    st.date_input("Choisisez une période de visualisation",
    value=(first_day, first_day+pd.DateOffset(days=30)), min_value=first_day, max_value=last_day)
            
    if len(date_range) == 1:
        date_range = (date_range[0], date_range[0]+pd.DateOffset(days=30))
            
    df_sub_data = path_[date_range[0]:date_range[1]]

    c1, c2 = st.columns((7,3))
    with c1:
        st.markdown('### Heatmap')
        # plost.time_hist(
        # data=seattle_weather,
        # date='date',
        # x_unit='week',
        # y_unit='day',
        # color=time_hist_color,
        # aggregate='median',
        # legend=None,
        # height=345,
        # use_container_width=True)
    with c2:
        st.markdown('### Donut chart')
        plost.donut_chart(
            data=stocks,
            theta=donut_theta,
            color='company',
            legend='bottom', 
            use_container_width=True)

    # Row C
    st.markdown('### Line chart')
    st.line_chart(seattle_weather, x = 'date', y = plot_data, height = plot_height)




with st.container():
            with st.spinner(text="En cours ..."):
                    st.pyplot(mpl_display_ts_multiple_predictions(
                        df_data, l_pred_col=l_pred_col,
                        true_y=target, x_label='', y_label="Consumption (KW)",
                        title="", ax_titles=ax_titles))














import streamlit as st
import pandas as pd
from io import StringIO
import plost
import pickle
from streamlit_option_menu import option_menu
from src.data_analysis import importation_of_dataset  , box_plot , add_month_or_hour, boxplot_months
import numpy as np
import matplotlib.pyplot as plt



def mpl_display_ts_multiple_predictions(df_data, l_pred_col, true_y, x_label='', y_label='',
                                        title="Power consumption prediction",
                                        ax_titles=None):

    n_pred = len(l_pred_col)
    fig, ax = plt.subplots(n_pred, 1, figsize=(10, 8), constrained_layout=True,
                           sharex=True, sharey=True)

    if ax_titles is None or len(ax_titles) < n_pred:
        ax_titles=['Prediction {}'.format(i) for i in range(n_pred)]


    for i in range(n_pred):
        df_data.plot(y=true_y, ax=ax[i], color='k', linewidth=1)
        df_data.plot(y=l_pred_col[i], ax=ax[i], color='b', style='.', linewidth=0.1, alpha=0.2)
        ax[i].set_title(ax_titles[i])
        ax[i].legend(["Raw Data", l_pred_col[i]], bbox_to_anchor=(1.02, 1), loc='upper left', borderaxespad=0)
        ax[i].set_ylabel(y_label)
    fig.suptitle(title)
    return fig


def read_pred_results(file_pkl):
    with open(file_pkl, 'rb') as fp:
        df_predictions = pickle.load(fp)
    return df_predictions

def draw_forecast_page():
    path_ = "Tetuan City power consumption.csv"
    path_ = importation_of_dataset(path_)

    first_day = path_.index[0]
    last_day = path_.index[-1]
    


    # Différents fichiers de résultats
    # Zone 1
    file_z1_lstm1h = "predictions/Zone1/lstm1H_predictions_Consumption_Z1.pkl"

    # Zone 2
    file_z2_lstm1h = "predictions/Zone2/lstm1H_predictions_Consumption_Z2.pkl"

    # Sone 3
    file_z3_lstm1h = "predictions/Zone3/lstm1H_predictions_Consumption_Z3.pkl"



     # chargement des différentes données
    df_z1_lstm1h = read_pred_results(file_z1_lstm1h)
    
    df_z2_lstm1h = read_pred_results(file_z2_lstm1h)
    
    df_z3_lstm1h = read_pred_results(file_z3_lstm1h)


    l_pred_col=["LSTM_1H"]
    ax_titles=["Prédictions LSTM_1H"]
    


    
    with st.container():
       st.write("")
       st.write(f""" ### Prédictions des différents modèles pas zone  """)
       st.info("""
          :point_down: **Résultats obtenus par zone**
      """)
      
    with st.container():
        zone_col, window_col= st.columns(2)
        
        with zone_col:
            zones = st.radio('**Zones de la ville de Tétouan**',
                             ('Zone 1', 'Zone 2', 'Zone 3'))
        

        with window_col:
            window = st.radio("**Fenêtre d'analyse**",
                              ('Globale', 'Personnalisée')) 
            

    

   









    if zones=="Zone 1":
        # Plage de dates des données
        first_day = df_z1_lstm1h .index[0]
        last_day = df_z1_lstm1h.index[-1]
        
        # Merge the dataframe
        df_z1_lstm1h.rename(columns={"prediction":"LSTM_1H"}, inplace=True)
        # df_data = pd.concat([df_z1_lstm1h[["LSTM_1H"]]], axis=1)        
        df_data = df_z1_lstm1h[["LSTM_1H"]]
        target="Consumption_Z1"

    if zones=="Zone 2":
        # Plage de dates des données
        first_day = df_z2_lstm1h.index[0]
        last_day = np.array(
        df_z2_lstm1h.index[-1])
        
        # Merge the dataframe
        df_z2_lstm1h.rename(columns={"prediction":"LSTM_1H"}, inplace=True)
        # df_data = pd.concat([df_z2_lstm1h[["LSTM_1H"]]], axis=1)*
        df_data = df_z2_lstm1h[["LSTM_1H"]]
        target="Consumption_Z2"
        
    if zones=="Zone 3":
        # Plage de dates des données
        first_day = df_z3_lstm1h.index[0]
        last_day = df_z3_lstm1h.index[-1]
        
        # Merge the dataframe
        df_z3_lstm1h.rename(columns={"prediction":"LSTM_1H"}, inplace=True)
        #df_data = pd.concat([df_z3_lstm1h[["LSTM_1H"]]], axis=1)
        df_data = df_z3_lstm1h[["LSTM_1H"]]
        target="Consumption_Z3"
        
    if window == 'Globale':           
        with st.container():
            with st.spinner(text="En cours ..."):
                    st.pyplot(mpl_display_ts_multiple_predictions(
                        df_data, l_pred_col=l_pred_col,
                        true_y=target, x_label='', y_label="Consumption (KW)",
                        title="", ax_titles=ax_titles))
                


                
           
    else:
       # Sélectionner un intervalle de dates
       st.info("""
           :point_down: **Période de visualisation personnalisée.**
       """)
       date_range = \
           st.date_input("Choisisez une période de visualisation",
                         value=(first_day,
                                first_day+pd.DateOffset(days=7)),
                         min_value=first_day, max_value=last_day)
       if len(date_range) == 1:
           date_range = (date_range[0], 
                         min(date_range[0]+pd.DateOffset(days=7), last_day))
           
       df_sub_data = df_data[date_range[0]:date_range[1]]
       with st.spinner(text="En cours ..."):
            st.pyplot(mpl_display_ts_multiple_predictions(
                df_sub_data, l_pred_col=l_pred_col,
                true_y=target, x_label='', y_label="Consumption (KW)",
                title="", ax_titles=ax_titles))
       
      
      


    


            

















    with open('style.css') as f:
        st.markdown(f'<style>{f.read()}</style>', unsafe_allow_html=True)
    
   

    # Row A
    # st.markdown('### Metrics')
    # col1, col2, col3 = st.columns(3)
    # col1.metric("Temperature", "70 °F", "1.2 °F")
    # col2.metric("Wind", "9 mph", "-8%")
    # col3.metric("Humidity", "86%", "4%")

   

    


